# C++ 存储类

存储类是 C++中用于管理对象的:

- 生存期
- 链接属性
- 内存位置

的类型说明符。每个对象只能有一个存储类。

## 基本概念

- **默认行为**: 块内定义的变量默认为自动存储，除非使用 `extern`、`static` 或 `thread_local` 另行指定
- **自动对象特点**:
  - 不具有链接性(块外不可见)
  - 进入块时分配内存
  - 退出块时释放内存

## static 关键字

### 使用场景

1. **文件作用域**

   - 用于: 全局/命名空间中的变量或函数
   - 效果: 指定内部链接

2. **函数内部**

   - 效果: 变量在函数调用间保持状态

   ```cpp
   void counter() {
       static int count = 0;  // 值会在函数调用间保持
       count++;
   }
   ```

3. **类成员变量**

   - 效果: 所有实例共享一个副本
   - 要求: 必须在类外定义

   ```cpp
   class MyClass {
       static int count;  // 声明
   };
   int MyClass::count = 0;  // 定义
   ```

4. **类成员函数**
   - 效果: 所有实例共享此函数
   - 限制: 无法访问非静态成员(没有 this 指针)

### 特殊说明

- 从 C++11 起，静态局部变量的初始化是线程安全的
- 可用 `/Zc:threadSafeInit-` 禁用线程安全初始化

## extern 关键字

- **用途**: 声明在其他翻译单元中定义的对象
- **效果**: 指定对象具有外部链接

## thread_local 说明符

### 基本特性

- 变量仅在创建它的线程上可访问
- 生命周期与线程同步
- 每个线程拥有独立副本

### 使用规则

```cpp
thread_local float global = 42.0;  // 全局命名空间

class Example {
    thread_local static int val;    // 正确：静态成员
    thread_local int x;             // 错误：必须是静态成员
};
```

### 注意事项

1. 只能用于数据声明和定义
2. 只能用于静态存储期的数据项
3. DLL 中的动态初始化可能存在问题
4. 可与 `static` 或 `extern` 组合使用
5. 不建议与 `std::launch::async` 一起使用

## 存储类示例

### 自动 vs 静态初始化

```cpp
void example() {
    InitDemo auto1("Auto");     // 每次进入函数都初始化
    static InitDemo static1("Static");  // 只在第一次进入函数时初始化
}
```

生命周期比较：

- 自动对象：函数返回时销毁
- 静态对象：程序结束时销毁
- 线程局部对象：线程结束时销毁
